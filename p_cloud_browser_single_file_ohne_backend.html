<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bilder – pCloud Galerie (Read‑only)</title>
  <style>
    :root{
      --paper:#ffffff; --card:#ffffff;
      --gold:#cfa435; --blue:#2a5298;
      --fg-strong:#0f172a; --fg:#334155; --fg-soft:#64748b;
      --border:#e5e7eb; --divider:#f1f5f9;
      --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.08);
      --ease:cubic-bezier(.2,.8,.16,1);
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.6 Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--fg); background:var(--paper)}
    .wrap{max-width:1100px; margin:0 auto; padding:36px 18px}

    header{display:flex; align-items:center; gap:14px; margin-bottom:18px}
    .seal{width:44px; height:44px; border-radius:14px; background:conic-gradient(from 180deg,var(--gold),var(--blue),var(--gold)); box-shadow:var(--shadow)}
    h1{margin:0; font-size:1.7rem; color:var(--fg-strong)}
    .sub{margin:2px 0 0; color:var(--fg-soft)}

    .card{border:1px solid var(--border); background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow)}
    .hint{padding:0 14px 14px; color:var(--fg-soft); font-size:.92rem}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); padding:14px; border-top:1px solid var(--divider); align-items:start}
    .tile{border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#fff; box-shadow:var(--shadow); display:flex; flex-direction:column; padding:8px}
    .ph{background:#f8fafc; display:inline-flex; align-items:center; justify-content:center; width:100%;}
    .ph img{max-width:100%; max-height:100%; object-fit:contain; background:#f8fafc;}
    .meta{padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:8px}
    .name{font-size:.95rem; color:var(--fg-strong); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:70%}
    .dl{display:inline-flex; align-items:center; gap:8px}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid transparent; background:var(--blue); color:#fff; cursor:pointer}
    .btn.sec{background:#fff; color:var(--blue); border:1px solid var(--blue)}

    .empty{padding:18px; text-align:center; color:var(--fg-soft)}
    .err{padding:12px 14px; color:#b91c1c; background:#fef2f2; border:1px solid #fecaca; border-radius:12px; margin:0 14px 14px}

    /* Video-Overlay (Play-Icon) */
    .tile.video .ph{background:#f8fafc; display:inline-flex; align-items:center; justify-content:center; width:100%;}
    .tile.video .ph::after{content:''; position:absolute; inset:0; background:radial-gradient(circle at 50% 50%, rgba(0,0,0,.0) 55%, rgba(0,0,0,.25) 56%)}
    .tile.video .ph .play{position:absolute; left:50%; top:50%; width:44px; height:44px; transform:translate(-50%,-50%); border-radius:999px; background:rgba(0,0,0,.55); display:grid; place-items:center}
    .tile.video .ph .play::before{content:''; display:block; margin-left:2px; width:0; height:0; border-left:12px solid #fff; border-top:8px solid transparent; border-bottom:8px solid transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="seal"></div>
      <div>
        <h1>Bilder – pCloud Galerie</h1>
        <div class="sub">Einfach ansehen & mit einem Klick herunterladen • Bilder & Videos • Daten liegen bei pCloud</div>
      </div>
    </header>

    <section class="card" id="app">
      <div id="error" class="err" style="display:none"></div>
      <div class="hint">Bilder & Videos aus dem freigegebenen pCloud‑Ordner. Vorschau direkt hier, Download je Datei als ZIP.</div>
      <div id="grid" class="grid">
        <div class="empty" id="empty">Noch nichts geladen.</div>
      </div>
    </section>
  </div>

  <script>
    const el = s => document.querySelector(s);
    const grid = el('#grid');
    const empty = el('#empty');
    const errorBox = el('#error');
    const DEFAULT_CODE = 'kZ29hOZ00ToaEdmBum44JhXAi5YSYFWXhJk';

    const IMAGE_EXT = ['jpg','jpeg','png','gif','webp','bmp','tif','tiff','heic','heif'];
    const VIDEO_EXT = ['mp4','mov','webm','m4v','avi','mkv'];
    const isImage = (name='') => IMAGE_EXT.includes((name.split('.').pop()||'').toLowerCase());
    const isVideo = (name='') => VIDEO_EXT.includes((name.split('.').pop()||'').toLowerCase());

    function flatten(meta, prefix=''){
      const out=[]; if(!meta) return out;
      if(meta.isfolder && meta.contents){
        for(const it of meta.contents){
          if(it.isfolder){ out.push(...flatten(it, prefix + it.name + '/')); }
          else { out.push({...it, path: prefix + it.name}); }
        }
      } else if(!meta.isfolder){
        out.push({...meta, path: meta.name});
      }
      return out;
    }

    async function loadPublink(code){
      grid.innerHTML = '';
      empty?.remove?.();
      errorBox.style.display='none';
      try{
        // Region automatisch erkennen: erst EU, dann US
        const hosts = ['https://eapi.pcloud.com','https://api.pcloud.com'];
        let ok = null, last = null;
        for(const base of hosts){
          try{
            const res = await fetch(`${base}/showpublink?code=${encodeURIComponent(code)}`);
            const data = await res.json();
            last = data;
            if(data && data.result === 0){ ok = {base, data}; break; }
          }catch(e){ last = e; }
        }
        if(!ok){
          const msg = (last && last.result) ? `API result ${last.result} (Publink ungültig/nicht öffentlich oder Region passt nicht)` : `API/Netzwerk-Fehler`;
          throw new Error(msg);
        }
        const {base, data} = ok;
        const files = flatten(data.metadata).map(f => ({...f, _isImg: isImage(f.name), _isVid: isVideo(f.name)}));
        if(!files.length){ grid.innerHTML = `<div class="empty">Keine Dateien gefunden.</div>`; return; }

        grid.innerHTML = files.map(f => {
          const baseName = (f.path||f.name);
          const safeTitle = baseName.replace(/\"/g,'&quot;');
          const thumb = f._isImg
            ? `${base}/getpubthumb?code=${encodeURIComponent(code)}&fileid=${encodeURIComponent(f.fileid)}&size=800x800&crop=1`
            : `data:image/svg+xml;utf8,` + encodeURIComponent(`<?xml version=\"1.0\"?><svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23f1f5f9'/><g font-family='Inter, Arial' fill='%23334155'><text x='50%' y='50%' font-size='28' text-anchor='middle' dominant-baseline='middle'>${(f.name.split('.').pop()||'FILE').toUpperCase()}</text></g></svg>`);
          const zipOne = `${base}/getpubzip?code=${encodeURIComponent(code)}&fileid=${encodeURIComponent(f.fileid)}&filename=${encodeURIComponent(f.name + '.zip')}`;
          const preview = `https://u.pcloud.link/publink/show?code=${encodeURIComponent(code)}`;
          const cls = f._isVid ? 'tile video' : 'tile';
          return `<figure class="${cls}">
            <div class="ph"><img loading="lazy" src="${thumb}" alt="${safeTitle}" onerror="this.src=''; this.parentElement.classList.add('ph');"/>${f._isVid?'<span class=\"play\"></span>':''}</div>
            <figcaption class="meta">
              <div class="name" title="${safeTitle}">${(f.name||'Datei')}</div>
              <div class="dl">${f._isVid?`<a class=\"btn sec\" href=\"${preview}\" target=\"_blank\" rel=\"noopener\">Anzeigen</a>`:''}<a class="btn sec" href="${zipOne}">Download</a></div>
            </figcaption>
          </figure>`;
        }).join('');
      }catch(err){
        console.error(err);
        errorBox.textContent = 'Fehler beim Laden: ' + err.message;
        errorBox.style.display='block';
        grid.innerHTML = `<div class="empty">Fehler.</div>`;
      }
    }

    // Auto‑Load mit festem Publink‑Code – erst wenn DOM bereit ist
    document.addEventListener('DOMContentLoaded', ()=>{
      grid.innerHTML = '<div class="empty">Lade…</div>';
      loadPublink(DEFAULT_CODE);
    });
  </script>
</body>
</html>
