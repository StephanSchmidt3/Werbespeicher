<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bilder – pCloud Galerie (Read‑only)</title>
  <style>
    :root{
      --paper:#ffffff; --card:#ffffff;
      --gold:#cfa435; --blue:#2a5298;
      --fg-strong:#0f172a; --fg:#334155; --fg-soft:#64748b;
      --border:#e5e7eb; --divider:#f1f5f9;
      --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.08);
      --ease:cubic-bezier(.2,.8,.16,1);
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.6 Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--fg); background:var(--paper)}
    .wrap{max-width:1100px; margin:0 auto; padding:36px 18px}

    header{display:flex; align-items:center; gap:14px; margin-bottom:18px}
    .seal{width:44px; height:44px; border-radius:14px; background:conic-gradient(from 180deg,var(--gold),var(--blue),var(--gold)); box-shadow:var(--shadow)}
    h1{margin:0; font-size:1.7rem; color:var(--fg-strong)}
    .sub{margin:2px 0 0; color:var(--fg-soft)}

    .card{border:1px solid var(--border); background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow)}
    .hint{padding:0 14px 14px; color:var(--fg-soft); font-size:.92rem}
    .crumbs{display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--fg-soft)}
    .crumbs a{color:var(--blue); text-decoration:none; padding:4px 8px; border-radius:8px}
    .crumbs a:hover{background:#eef2ff}
    .crumbs .sep{opacity:.6}
    .crumbs .here{color:var(--fg-strong)}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); padding:14px; border-top:1px solid var(--divider); align-items:start}
    .tile{border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#fff; box-shadow:var(--shadow); display:flex; flex-direction:column; padding:8px}
    .tile.folder{cursor:pointer}
    .tile.folder:hover{border-color:var(--blue); box-shadow:0 6px 22px rgba(42,82,152,.12)}
    .ph{background:#f8fafc; display:inline-flex; align-items:center; justify-content:center; width:100%; position:relative; z-index:1;}
    .ph img{max-width:100%; max-height:100%; object-fit:contain; background:#f8fafc;}
    .meta{padding:10px 12px; display:flex; justify-content:space-between; align-items:center; gap:8px; position:relative; z-index:2}
    .name{font-size:.95rem; color:var(--fg-strong); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:70%}
    .dl{display:inline-flex; align-items:center; gap:8px}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid transparent; background:var(--blue); color:#fff; cursor:pointer}
    .btn.sec{background:#fff; color:var(--blue); border:1px solid var(--blue)}

    .toolbox{display:flex; gap:8px; pointer-events:auto; position:relative; z-index:3}
    .toolbox .iconbtn{pointer-events:auto}
    .iconbtn{width:36px; height:36px; border:1px solid var(--divider); background:#fff; color:var(--blue); border-radius:10px; display:grid; place-items:center; cursor:pointer; transition:transform .15s var(--ease), box-shadow .15s var(--ease), border-color .2s}
    .iconbtn:hover{transform:translateY(-1px); border-color:var(--blue); box-shadow:0 2px 10px rgba(42,82,152,.12)}
    .iconbtn svg{width:18px; height:18px}

    .toast{position:fixed; left:50%; bottom:16px; transform:translateX(-50%) translateY(12px); background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.2); opacity:0; pointer-events:none; transition:opacity .25s var(--ease), transform .25s var(--ease); font-size:.9rem}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    .empty{padding:18px; text-align:center; color:var(--fg-soft)}
    .err{padding:12px 14px; color:#b91c1c; background:#fef2f2; border:1px solid #fecaca; border-radius:12px; margin:0 14px 14px}

    /* Video-Overlay (Play-Icon) */
    .tile.video .ph{background:#f8fafc; display:inline-flex; align-items:center; justify-content:center; width:100%;}
    .ph{position:relative;}
/* entfernt: dunkler Overlay */
    .badge-play{position:absolute; right:8px; bottom:8px; width:28px; height:28px; border-radius:999px; background:rgba(42,82,152,.9); color:#fff; display:grid; place-items:center; box-shadow:0 2px 6px rgba(0,0,0,.2); pointer-events:none}
.badge-play::before{content:''; width:0; height:0; border-left:8px solid #fff; border-top:6px solid transparent; border-bottom:6px solid transparent; margin-left:2px}
      /* Folder-Visuals */
    .ph svg{display:block; width:100%; height:auto; max-height:180px}
    .ph-folder{padding:12px}
    /* Folder collage preview */
    .ph-collage{position:relative; display:grid; grid-template-columns:repeat(4,1fr); grid-auto-rows:1fr; gap:2px; width:100%; aspect-ratio:4/3; background:#f8fafc; border-radius:12px; overflow:hidden}
    .ph-collage img{width:100%; height:100%; object-fit:cover; border-radius:4px; background:#eef2f7}
    .collage-more{position:absolute; right:6px; bottom:6px; background:rgba(17,24,39,.72); color:#fff; padding:2px 8px; border-radius:999px; font-size:.75rem; line-height:1; box-shadow:0 2px 6px rgba(0,0,0,.18)}
    .folder-fallback{width:100%; height:100%; border-radius:12px; background:linear-gradient(135deg,#eef2ff,#e0e7ff); display:grid; place-items:center; color:#64748b; font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="seal"></div>
      <div>
        <h1>Bilder – pCloud Galerie</h1>
        <div class="sub">Einfach ansehen & mit einem Klick herunterladen • Bilder & Videos • Daten liegen bei pCloud</div>
      </div>
    </header>

    <section class="card" id="app">
      <div id="error" class="err" style="display:none"></div>
      <div class="hint">Bilder & Videos aus dem freigegebenen pCloud‑Ordner. Vorschau direkt hier, Download je Datei als ZIP.</div>
      <nav class="crumbs" id="crumbs" aria-label="Brotkrumen" style="padding:0 14px 8px; border-top:1px solid var(--divider);"></nav>
      <div id="grid" class="grid">
        <div class="empty" id="empty">Noch nichts geladen.</div>
      </div>
    </section>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
(()=>{
  const $ = s => document.querySelector(s);
  const grid = $('#grid');
  const crumbs = $('#crumbs');
  const errorBox = $('#error');
  const DEFAULT_CODE = 'kZ29hOZ00ToaEdmBum44JhXAi5YSYFWXhJk';
  console.log('[pCloud] init with code', DEFAULT_CODE);

  const IMG_EXT = ['jpg','jpeg','png','gif','webp','bmp','tif','tiff','heic','heif'];
  const VID_EXT = ['mp4','mov','webm','m4v','avi','mkv'];
  const isImg = n => IMG_EXT.includes((n.split('.').pop()||'').toLowerCase());
  const isVid = n => VID_EXT.includes((n.split('.').pop()||'').toLowerCase());

  function showToast(msg){
    let t = document.getElementById('toast');
    if(!t){ t = document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t); }
    t.textContent = msg; t.classList.add('show');
    clearTimeout(showToast._t); showToast._t=setTimeout(()=> t.classList.remove('show'), 1600);
  }

  let ACTIVE_BASE='', ACTIVE_CODE='';
  let ROOT=null, CURRENT_PATH='';

  function nodeByPath(root, path){
    if(!path) return root;
    const segs = path.split('/').filter(Boolean);
    let n = root;
    for(const s of segs){ if(!n||!n.contents) return null; n = n.contents.find(x=>x.isfolder && x.name===s); }
    return n;
  }

  function renderCrumbs(){
    const segs = CURRENT_PATH.split('/').filter(Boolean);
    let acc=''; const parts=[`<a href="#" data-path="">Start</a>`];
    for(const s of segs){ acc += s + '/'; parts.push('<span class="sep">›</span>'); parts.push(`<a href="#" data-path="${acc}">${s}</a>`); }
    crumbs.innerHTML = parts.join(' ');
    crumbs.querySelectorAll('a').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); CURRENT_PATH = a.dataset.path || ''; render(); }));
  }

  function render(){
    console.log('[pCloud] render for path', CURRENT_PATH);
    renderCrumbs();
    const node = nodeByPath(ROOT, CURRENT_PATH);
    if(!node){ grid.innerHTML = '<div class="empty">Ordner nicht gefunden.</div>'; return; }

    const folders = (node.contents||[]).filter(x=>x.isfolder);
    const files = (node.contents||[]).filter(x=>!x.isfolder);

    const htmlFolders = folders.map(f=>{
      const path = (CURRENT_PATH + f.name + '/');
      const safePath = path.replace(/"/g,'&quot;');
      // Collage: bis zu 12 Bilder, rekursiv
      const collect=(n,a=[])=>{ if(!n||!n.contents) return a; for(const it of n.contents){ if(it.isfolder) collect(it,a); else if(isImg(it.name)) a.push(it);} return a; };
      const imgs = collect(f, []);
      const MAX=12; const show = imgs.slice(0,MAX); const more = Math.max(0, imgs.length-MAX);
      const collage = show.length ? show.map(ch=>{
        const t = `${ACTIVE_BASE}/getpubthumb?code=${encodeURIComponent(ACTIVE_CODE)}&fileid=${encodeURIComponent(ch.fileid)}&size=256x256&crop=1`;
        const alt = (ch.name||'Bild').replace(/"/g,'&quot;');
        return `<img src="${t}" alt="${alt}" loading="lazy">`;
      }).join('') + (more?`<span class="collage-more">+${more}</span>`:'') : `<div class="folder-fallback"></div>`;

      return `<figure class="tile folder" data-path="${safePath}" role="button" tabindex="0" aria-label="Ordner ${f.name} öffnen">
        <div class="ph ph-collage">${collage}</div>
        <figcaption class="meta">
          <div class="name">${f.name}</div>
          <div class="toolbox"><svg aria-hidden="true" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--blue)"><path d="M9 18l6-6-6-6"/></svg></div>
        </figcaption>
      </figure>`;
    }).join('');

    const htmlFiles = files.map(f=>{
      const safeTitle = (CURRENT_PATH + f.name).replace(/"/g,'&quot;');
      const thumb = isImg(f.name)
        ? `${ACTIVE_BASE}/getpubthumb?code=${encodeURIComponent(ACTIVE_CODE)}&fileid=${encodeURIComponent(f.fileid)}&size=800x800&crop=0`
        : (isVid(f.name)
            ? 'data:image/svg+xml;utf8,' + encodeURIComponent(`<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23ffffff'/><circle cx='400' cy='300' r='72' fill='%232a5298'/><polygon points='380,260 460,300 380,340' fill='white'/></svg>')
            : 'data:image/svg+xml;utf8,' + encodeURIComponent(`<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23f1f5f9'/><g font-family='Inter, Arial' fill='%23334155'><text x='50%' y='50%' font-size='28' text-anchor='middle' dominant-baseline='middle'>${(f.name.split('.').pop()||'FILE').toUpperCase()}</text></g></svg>')
          );
      const zipUrl = `${ACTIVE_BASE}/getpubzip?code=${encodeURIComponent(ACTIVE_CODE)}&fileid=${encodeURIComponent(f.fileid)}&filename=${encodeURIComponent(f.name + '.zip')}`;
      return `<figure class="tile${isVid(f.name)?' video':''}">
        <div class="ph"><img loading="lazy" src="${thumb}" alt="${safeTitle}">${isVid(f.name)?'<span class="badge-play"></span>':''}</div>
        <figcaption class="meta">
          <div class="name" title="${safeTitle}">${f.name}</div>
          <div class="toolbox">
            <a class="iconbtn download-btn" href="${zipUrl}" title="Download" aria-label="Download"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 21h14"/></svg></a>
            <button class="iconbtn share-btn" type="button" data-url="${zipUrl}" data-name="${safeTitle}" title="Teilen" aria-label="Teilen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98"/><path d="M15.41 6.51L8.59 10.49"/></svg></button>
          </div>
        </figcaption>
      </figure>`;
    }).join('');

    grid.innerHTML = htmlFolders + htmlFiles;

    // Folder: ganze Kachel klickbar
    grid.querySelectorAll('.folder').forEach(card=>{
      const go = ()=>{ CURRENT_PATH = card.dataset.path; render(); };
      card.addEventListener('click', go);
      card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); go(); } });
    });

    // Icons: Klicks explizit behandeln
    grid.querySelectorAll('.download-btn').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        const url = a.getAttribute('href');
        try{ const tmp=document.createElement('a'); tmp.href=url; tmp.target='_blank'; tmp.rel='noopener'; tmp.download=''; document.body.appendChild(tmp); tmp.click(); setTimeout(()=> tmp.remove(),0); }
        catch{ location.href=url; }
      });
    });
    grid.querySelectorAll('.share-btn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.preventDefault(); e.stopPropagation();
        const url = btn.dataset.url; const name = btn.dataset.name || 'Datei';
        try{ if(navigator.share){ await navigator.share({title:name, url}); return; } }catch{}
        try{ await navigator.clipboard.writeText(url); showToast('Link kopiert'); return; }catch{}
        try{ const ta=document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('Link kopiert'); return; }catch{}
        window.prompt('Link zum Teilen:', url);
      });
    });
  }

  async function loadPublink(code){
    grid.innerHTML = '<div class="empty">Lade…</div>';
    errorBox.style.display='none';
    try{
      const hosts=['https://eapi.pcloud.com','https://api.pcloud.com'];
      let ok=null,last=null;
      for(const base of hosts){
        try{ const res=await fetch(`${base}/showpublink?code=${encodeURIComponent(code)}`);
             const data=await res.json();
             console.log('[pCloud] call', base, '→', data && data.result);
             last=data; if(data&&data.result===0){ ok={base,data}; break; } }
        catch(e){ console.error('[pCloud] fetch error', e); last=e; }
      }
      if(!ok){ const msg=(last && last.result)?`API result ${last.result}`:`API/Netzwerk-Fehler`;
        throw new Error(msg); }
      ACTIVE_BASE=ok.base; ACTIVE_CODE=code;
      const meta = ok.data && ok.data.metadata;
      if(!meta){ throw new Error('Keine Metadaten vom Server.'); }
      ROOT=meta; CURRENT_PATH='';
      render();
    }catch(err){ console.error('[pCloud] load error', err);
      errorBox.textContent='Fehler beim Laden: '+ err.message + ' — bitte Link prüfen oder später erneut versuchen.';
      errorBox.style.display='block';
      grid.innerHTML='<div class="empty">Fehler.</div>';
    }
  }/showpublink?code=${encodeURIComponent(code)}`); const data=await res.json(); last=data; if(data&&data.result===0){ ok={base,data}; break; } }
        catch(e){ last=e; }
      }
      if(!ok){ const msg=(last&&last.result)?`API result ${last.result}`:'API/Netzwerk-Fehler'; throw new Error(msg); }
      ACTIVE_BASE=ok.base; ACTIVE_CODE=code; ROOT=ok.data.metadata; CURRENT_PATH='';
      render();
    }catch(err){ console.error(err); errorBox.textContent='Fehler beim Laden: '+err.message; errorBox.style.display='block'; grid.innerHTML='<div class="empty">Fehler.</div>'; }
  }

  document.addEventListener('DOMContentLoaded', ()=> loadPublink(DEFAULT_CODE));
})();
</script>
</body>
</html>
