<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Synergy – Werbegalerie</title>
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --accent:#2a5298; --soft:#f8fafc; --paper:#ffffff; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.55 Inter, ui-sans-serif, system-ui, Arial, sans-serif; color:var(--fg); background:var(--paper)}
    .wrap{max-width:1000px; margin:0 auto; padding:20px}
    header{display:flex; align-items:flex-start; gap:12px; margin-bottom:8px}
    h1{margin:0; font-size:2rem}
    .sub{color:var(--muted)}

    .card{border:1px solid var(--border); border-radius:14px; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .crumbs{padding:10px 14px; border-bottom:1px solid var(--border); font-size:.95rem}
    .crumbs a{color:var(--accent); text-decoration:none}
    .crumbs .sep{opacity:.6; margin:0 6px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); padding:14px}
    .tile{background:transparent; transition:transform .18s ease, box-shadow .18s ease}
    .tile:hover{transform:translateY(-2px);}

    /* --- Ordner-Collage: 3x3, ohne Kästchen-Umrandung --- */
    .ph-collage{display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:2px; width:100%; aspect-ratio:1/1; background:#fff; overflow:hidden; border-radius:12px}
    .ph-collage img{width:100%; height:100%; object-fit:cover; display:block}
    .meta{padding:8px 10px; font-size:.92rem; color:var(--fg); text-overflow:ellipsis; white-space:nowrap; overflow:hidden; text-align:center}

    /* --- Datei-Vorschau: Bild selbst ohne Rahmen, nur Downloadbereich mit Rahmen --- */
    .ph{background:transparent; display:flex; align-items:center; justify-content:center; height:160px; overflow:hidden}
    .ph img{max-width:100%; max-height:100%; object-fit:contain; display:block}

    .toolbox{margin-top:8px; display:flex; justify-content:center}
    .bar{display:flex; gap:8px; align-items:center; justify-content:center; width:100%; border:1px solid var(--border); border-radius:12px; padding:8px; background:#fff}
    .iconbtn{width:36px; height:36px; border:1px solid var(--border); border-radius:10px; background:#fff; display:grid; place-items:center; color:var(--accent); cursor:pointer}
    .iconbtn:hover{border-color:#cbd5e1; background:#f8fafc}
    .dl-btn:hover{border-color:#cbd5e1; background:#f8fafc}

    .empty{padding:20px; text-align:center; color:var(--muted)}
    .err{margin:12px 14px; padding:10px; border:1px solid #fecaca; background:#fef2f2; color:#b91c1c; border-radius:10px; display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Synergy – Werbegalerie</h1>
        <div class="sub">Werbung für deinen Erfolg bei Synergy</div>
      </div>
    </header>

    <section class="card" id="app">
      <nav class="crumbs" id="crumbs"></nav>
      <div id="error" class="err"></div>
      <div id="grid" class="grid"><div class="empty">Lade…</div></div>
    </section>
  </div>

  <script>
  (function(){
    const DEFAULT_CODE = 'kZ29hOZ00ToaEdmBum44JhXAi5YSYFWXhJk';
    const grid  = document.getElementById('grid');
    const crumbs= document.getElementById('crumbs');
    const error = document.getElementById('error');

    let ROOT=null, CURRENT_PATH='', ACTIVE_BASE='', ACTIVE_CODE='';

    const IMG_EXT = ['jpg','jpeg','png','gif','webp','bmp','tif','tiff','heic','heif'];
    const VID_EXT = ['mp4','mov','webm','m4v','avi','mkv'];
    const isImg = n => IMG_EXT.includes((n.split('.').pop()||'').toLowerCase());
    const isVid = n => VID_EXT.includes((n.split('.').pop()||'').toLowerCase());

    function nodeByPath(root, path){ if(!path) return root; const segs=path.split('/').filter(Boolean); let n=root; for(const s of segs){ if(!n||!n.contents) return null; n=n.contents.find(x=>x.isfolder && x.name===s); } return n; }
    function collectImages(folder){ let out=[]; if(!folder||!folder.contents) return out; for(const it of folder.contents){ if(it.isfolder) out=out.concat(collectImages(it)); else if(isImg(it.name)) out.push(it); } return out; }

    function renderCrumbs(){ const segs=CURRENT_PATH.split('/').filter(Boolean); let acc=''; const p=[`<a href="#" data-path="">Start</a>`]; for(const s of segs){ acc+=s+'/'; p.push('<span class="sep">›</span>'); p.push(`<a href="#" data-path="${acc}">${s}</a>`);} crumbs.innerHTML=p.join(' '); crumbs.querySelectorAll('a').forEach(a=>a.addEventListener('click',e=>{e.preventDefault(); CURRENT_PATH=a.dataset.path||''; render();})); }

    function render(){
      renderCrumbs();
      const node = nodeByPath(ROOT, CURRENT_PATH);
      if(!node){ grid.innerHTML = '<div class="empty">Ordner nicht gefunden.</div>'; return; }
      const folders=(node.contents||[]).filter(x=>x.isfolder);
      const files  =(node.contents||[]).filter(x=>!x.isfolder);

      const htmlFolders = folders.map(f=>{
        const imgs = collectImages(f).slice(0,9);
        const thumbs = imgs.map(it=> `${ACTIVE_BASE}/getpubthumb?code=${encodeURIComponent(ACTIVE_CODE)}&fileid=${encodeURIComponent(it.fileid)}&size=256x256&crop=1`);
        const collage = thumbs.map(u=> `<img loading="lazy" src="${u}" alt="" onerror="this.style.opacity=0.15;">`).join('');
        return `<figure class="tile folder" data-path="${CURRENT_PATH+f.name+'/'}">
          <div class="ph-collage">${collage}</div>
          <figcaption class="meta">${f.name}</figcaption>
        </figure>`;
      }).join('');

      const htmlFiles = files.map(f=>{
        const fileid = encodeURIComponent(f.fileid);
        const code   = encodeURIComponent(ACTIVE_CODE);
        const thumb  = isImg(f.name)
          ? `${ACTIVE_BASE}/getpubthumb?code=${code}&fileid=${fileid}&size=800x800&crop=0`
          : (isVid(f.name)
              ? 'data:image/svg+xml;utf8,'+encodeURIComponent(`<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23fff'/><circle cx='400' cy='300' r='72' fill='%232a5298'/><polygon points='380,260 460,300 380,340' fill='white'/></svg>`) 
              : 'data:image/svg+xml;utf8,'+encodeURIComponent(`<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='%23f1f5f9'/><g font-family='Inter, Arial' fill='%23334155'><text x='50%' y='50%' font-size='28' text-anchor='middle' dominant-baseline='middle'>FILE</text></g></svg>`)
            );
        const zipUrl = `${ACTIVE_BASE}/getpubzip?code=${code}&fileid=${fileid}&filename=${encodeURIComponent(f.name + '.zip')}&forcedownload=1`;
        return `<figure class="tile">
          <div class="ph"><img loading="lazy" src="${thumb}" alt="Vorschau"></div>
          <div class="toolbox"><div class="bar"><a class="iconbtn dl-btn" href="${zipUrl}" title="Download" aria-label="Download">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 21h14"/></svg>
            </a></div></div>
        </figure>`;
      }).join('');

      grid.innerHTML = (htmlFolders + htmlFiles) || '<div class="empty">Keine Inhalte</div>';
      grid.querySelectorAll('.folder').forEach(card=> card.addEventListener('click', ()=>{ CURRENT_PATH = card.dataset.path; render(); }));
    }

    async function loadPublink(code){
      grid.innerHTML = '<div class="empty">Lade…</div>';
      error.style.display='none';
      try{
        const base = 'https://eapi.pcloud.com';
        const res = await fetch(base+'/showpublink?code='+encodeURIComponent(code),{cache:'no-store'});
        const data = await res.json();
        if(!data || data.result!==0) throw new Error('API result '+(data?data.result:'null'));
        let meta = data.metadata; if(Array.isArray(meta)) meta = meta[0]; if(meta && meta.metadata && !meta.contents && meta.metadata.contents) meta = meta.metadata;
        ACTIVE_BASE=base; ACTIVE_CODE=code; ROOT=meta; CURRENT_PATH='';
        render();
      }catch(err){ error.textContent='Fehler beim Laden: '+err.message; error.style.display='block'; grid.innerHTML='<div class="empty">Fehler.</div>'; }
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('.dl-btn');
      if(!btn) return;
      e.preventDefault(); e.stopPropagation();
      let url = btn.getAttribute('href');
      if(!url) return;
      if(!/forcedownload=1/.test(url)) url += (url.includes('?')?'&':'?')+'forcedownload=1';
      let f = document.getElementById('dlframe');
      if(!f){ f=document.createElement('iframe'); f.id='dlframe'; f.style.display='none'; document.body.appendChild(f); }
      f.src = url + (url.includes('?')?'&':'?') + '_=' + Date.now();
    });

    document.addEventListener('DOMContentLoaded', ()=> loadPublink(DEFAULT_CODE));
  })();
  </script>
</body>
</html>
